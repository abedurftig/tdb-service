task uploadTestResults(type: Exec) {

    def name = rootProject.getName()
    def suffix = getTestRunSlug()
    workingDir './upload'

    commandLine './upload.sh', '-p ' + name, '-t ' + suffix

    // store the output instead of printing to the console:
    standardOutput = new ByteArrayOutputStream()
    ext.output = {
        return standardOutput.toString()
    }

}

def getTestRunSlug() {
    return System.getenv("TRAVIS_BRANCH") + "@" + System.getenv("TRAVIS_BUILD_NUMBER")
}

if (System.getProperty("upload-testresults")) {
    println("Test results will be uploaded.")
    test.finalizedBy(uploadTestResults)
} else {
    println("Test results will not be uploaded.")
}